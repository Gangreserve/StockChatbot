# StockChatbot
一个可进行股市查询的聊天机器人！

## 1. 摘要

随着互联网与人工智能的高速发展，人们切实的体会到了高新技术带来的便利，各种智能的产品使得计算机能够更精准，更方便的获取用户的需求，用户也从而节省了许多机械化工作的时间。

本项目的设计背景与目的则与此一致，即让用户以尽可能自然，贴近人类交流行为的方式来获取他们所需要的信息。本项目的最主要的应用场景为金融背景，在获取股票所需要的信息时，通常需要通过复杂的专业软件来进行查询，且用户时常要与图表打交道，因此，刚刚入门的新手往往不清楚如何来操作这些软件，更不用说看股票，记股票，选股票了。因此，针对这些希望投身金融业，注重应用且希望快速入门的用户，在此类人群的工作场景中，本项目能够较好的满足此部分人群的需求。

对于本项目，使用的编程语言为python，使用的最主要的工具为rasa_nlu和spacy。实现的主要核心技术为：基于正则表达式的格式化回答；通过关键词，正则表达式，spacy以及rasa_nlu等多种技术融合的意图识别和实体抽取；甄别否定实体技术；基于sqlite3的本地数据库查询技术；基于状态机和等待状态转换的含遗留任务且可处理拒绝状态的多轮多次查询技术；基于iexfinanceapi的股票信息查询。

从产品逻辑上看，本项目分为闲聊和股票推荐/查询两个部分。用户既可以和机器人进行一些闲聊等不涉及股票数据上的交流，也可以通过多轮查询来查询自己所需要的信息，由于查询的信息都是基于特定股票的，因此对于大部分的查询都需要先选定自己想查询的股票，然后才能进行后续操作。面对一些对股票不熟悉的用户，可以首先让机器人给自己推荐一些股票，通过查询本地数据库来返回结果。在得知了自己想查询的股票后，用户可以通过多轮查询来一步一步让机器人获取用户想查询的信息，对于其中的历史价格查询，由于数据量较大，因此可以选用以表格方式来回复用户，以文件方式发送。

## 2. 项目背景
### 2.1 证券软件
证券软件的实质是通过对交易市场信息数据的统计，按照一定的分析模型给出报表、指标图形、资讯链接以及参考建议等，使得用户可以统筹多方位的时空信息，加以一定的理论或经验知识对行情进行评估，以进行交易操作。

随着全球证券行业的计算机辅助分析技术和软件技术的不断提升，如今，面向大众的证券交易软件从动态行情分析、实时新闻资讯、智能选股、委托交易等方面进行了不同的探索，已变得更加实用化、功能化、智能化，使得用户在基本分析、技术分析、新闻资讯汇集、个性选股、自动选股、自动委托交易、止赢止损等方面获得更快、更全、更好的服务；国内证券软件开发商也根据市场需求开发出了种种不同特点的证券服务产品，具有代表性的有同花顺、大智慧、通达信等。
### 2.2 聊天机器人
聊天机器人是经由对话或文字进行交谈的计算机程序，能够模拟人类对话，也可用于实用的目的，如进行客户服务或资讯获取等。

作为用来模拟人类对话或聊天的程序，早期的聊天机器人的目标是让一个真正的人类认为他们正在和另一个人聊天。研发者将预先设定好的合理回答置入数据库中，当一句话被抛给聊天机器人后，词组和句子通过算法在数据库中识别，并找到最贴切的回答。词库的丰富程度和回复的速度，是聊天机器人的重要因素。

而现代的聊天机器人则通常搭载了更为复杂的自然语言处理（NLP）系统，进行诸如意图识别、实体检测、情感分析等诸多过程，并通过调用公开API整合互联网上的信息，来帮助算法给出更能满足用户需要的答案。目前，聊天机器人多作为“虚拟助理”的一部分，与许多应用系统、应用程序、网站、即时通讯平台（IM）相连接；而非助理的聊天机器人应用程序则包括AI聊天室以及社交机器人等。


## 3. 项目目的与项目任务
本项目的目的即构建一个可进行股市查询的聊天机器人，应达成以下项目控制要素：

1. 同一个问题多种选择性的回答，并提供缺省回答的方案；
2. 通过正则表达式、模式匹配、关键词提取、句法转换等来回答问题；
3. 通过正则表达式、最近邻分类法或者支持向量机之一或多种方案来提取用户意图；
4. 通过预建的命名实体类型、角色关系、依赖分析等来进行命名实体识别；
5. 基于RasaNLU的本地基础聊天机器人系统的构建；
6. 数据库查询并使用自然语言探索数据库内容（提取参数、创建查询、响应）；
7. 基于增量过滤器的单轮多次增量查询技术以及甄别否定实体技术；
8. 实现状态机的多轮多次查询技术，并能基于语境问题提供解释和回答；
9. 处理拒绝、等待状态转换和待定行动的多轮多次查询技术。

首先，应当按照RasaNLU中的训练数据为例子，自行构建训练数据并训练处模型来使用；同时在代码里应当尽量多的采用上述九项实现技术，最好能够从头到尾都用一遍，以此作为课程的复习过程。

要求至少能够实现三种意图的查询（比如问询某几种股票的股价信息、成交量信息、市值等），每种意图需要至少两轮查询从而得到查询结果。

本次训练利用英文完成询问和回答即可。

## 4. 项目工程详细设计

### 4.1 意图识别和实体抽取
根据以上步骤的设计与分析，对于意图识别，本项目采用了模型预测，正则表达式和关键字等结合的方法来进行，其中模型预测使用的为rasa_nlu和spacy。通过训练自己配置的语料库来得到对应的模型，然后使用interpreter.load()加载即可操作该类中的各种功能，包括实体抽取和意图识别。

只依靠于训练模型得到结果的精确度是远远不够的，对于一些实体和意图不明显的闲聊类消息，应当设置特殊的处理方式来保证机器人的对话流畅性。由此，本项目中采用了关键词，正则表达式的来辅助机器人进行回复，实现方式是使用字典来存储一系列意图以及意图对应的关键词。

除以上情景外，还存在有格式化消息的情况。对于这种消息，采用了固定套路回复的方式来处理，作为机器人的最后防线，这种方式能够有效保证机器人对话的流畅性，同时也能提醒用户更换自己问问题的形式。


### 4.2 查询类消息的处理
在意图识别和实体抽取环节，用户的信息被识别为查询类消息，且实体明确。由于对于不同特点的消息要采取不同的策略去处理，在功能查询部分存在有连贯性和逻辑性的要求，故需要刻板的、格式化的操作。本项目采用了状态机来处理，并在此基础上实现了带遗留任务、状态等待转换、拒绝甄别与处理的多轮多次查询。

在该类信息的条件下，用户可以根据自己的需求来查询自己所需要的信息，查询的具体实现方式为请求接口。

### 4.3 股票推荐请求的处理
有时，用户的需求可能并不是查询一些特定股票的相关信息，而是仅仅想获得一些系统推荐的股票，来作为自己的投资参考，在这种情况下，使用接口来查询存在效率低的问题，而使用数据库的方式在该种情况下效果较好。由于在进行该部分操作前，已经经历过实体抽取和意图识别，因此，此时，用户发送的消息中已经包含了所有数据库查询的必要条件，因此，此时只需要将相应的实体匹配上意图来生成SQL查询语句便可实现从本地数据库中进行信息查询。

相比于接口调用的方式，选用数据库的原因如下：
1. 数据库的查询速度比接口的请求速度要快很多，用户体验上使用数据库要远优于使用接口；
2. 数据库中可以自由添加自定义的各种特征以及要求，由此可以更好的满足用户的个性化查询；
3. 可以为后续可能的查询的推荐算法预留较大的开发空间。

此外，这里还需要实现否定甄别的功能，以在用户表达对当前推荐股票的否定情绪后不再推荐此股票。

### 4.4 回复消息的预处理
对于一些数据量比较庞大的信息（如历史价格等），通过简单的文本回答往往难以阅读、不甚美观，在这种情况下，需要选用适合的形式来回复消息，将文本转化成图片、表格等格式进行回答。

首先需要加以判断，然后处理返回的json串，按照格式生成相关文件来返回。此部分调用的是python自带的对excel表格处理的openpyxl库。

## 5. 项目成果展示

